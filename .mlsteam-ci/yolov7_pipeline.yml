format: v0.1
name: Yolov9 Setup & Training
vars:
  - name: base_model
    type: string
    label: Base Model
    default: yolov9-c.pt

  - name: data_folder
    type: folder
    label: Data Folder
    default: coco128

  - name: train_epoch
    type: string
    label: Training Epoch
    default: '1'

  - name: train_batchsize
    type: string
    label: Batch Size Per Device
    default: '4'

steps:
  - name: checkout code
    type: checkout
    needs: null
    dvc: no
    location: .

  - name: train
    type: docker_run
    needs:
      - checkout code
    image: p9ebc297/yolov9-train:v2
    flavor: medium
    folders:
      - ${data_folder}:/mlsteam/data/${data_folder}
    run: |
      python train_dual.py --workers 1 --device 0 --batch-size ${train_batchsize} --epochs ${train_epoch} --data data/${data_folder}.yaml \
          --img 640 --cfg models/detect/yolov9-c.yaml --weights ${base_model} \
          --name yolov9-custom --hyp hyp.scratch-high.yaml \
          --min-items 0 --close-mosaic 15

  - name: evaluate
    type: docker_run
    needs:
      - train
    image: p9ebc297/yolov9-train:v2
    flavor: medium
    folders:
      - ${data_folder}:/mlsteam/data/${data_folder}
    run: |
        python val_dual.py --data data/${data_folder}.yaml --img 640 --batch 32 --conf 0.001\
            --iou 0.7 --device 0 --weights 'runs/train/yolov9-custom/weights/best.pt' \
            --name yolov9_c_640_val
